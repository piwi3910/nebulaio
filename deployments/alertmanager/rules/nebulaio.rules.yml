# NebulaIO Prometheus Alerting Rules
# These rules define conditions that trigger alerts for monitoring NebulaIO.

groups:
  # System Health Alerts
  - name: nebulaio.system
    interval: 30s
    rules:
      - alert: NebulaIODown
        expr: up{job="nebulaio"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "NebulaIO instance {{ $labels.instance }} is down"
          description: "NebulaIO instance {{ $labels.instance }} has been unreachable for more than 1 minute."

      - alert: HighCPUUsage
        expr: process_cpu_seconds_total{job="nebulaio"} > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is above 80% for more than 5 minutes."

      - alert: HighMemoryUsage
        expr: (process_resident_memory_bytes{job="nebulaio"} / process_virtual_memory_max_bytes{job="nebulaio"}) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is above 85% for more than 5 minutes."

      - alert: TooManyOpenFiles
        expr: process_open_fds{job="nebulaio"} / process_max_fds{job="nebulaio"} > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Too many open file descriptors on {{ $labels.instance }}"
          description: "Open file descriptors are above 80% of the limit."

  # Cluster Health Alerts
  - name: nebulaio.cluster
    interval: 30s
    rules:
      - alert: ClusterNodeDown
        expr: nebulaio_cluster_node_healthy == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Cluster node {{ $labels.node_id }} is down"
          description: "Cluster node {{ $labels.node_id }} at {{ $labels.address }} is not responding."

      - alert: ClusterQuorumLost
        expr: nebulaio_cluster_nodes_healthy < (nebulaio_cluster_nodes_total / 2 + 1)
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Cluster has lost quorum"
          description: "Less than half of cluster nodes are healthy. Cluster may be unable to accept writes."

      - alert: ClusterLeadershipChanges
        expr: changes(nebulaio_cluster_leader_changes_total[5m]) > 3
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Frequent cluster leadership changes"
          description: "Cluster leadership has changed more than 3 times in the last 5 minutes."

      - alert: DragonboatLogBehind
        expr: nebulaio_dragonboat_commit_index - nebulaio_dragonboat_applied_index > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Dragonboat Raft log is behind on {{ $labels.instance }}"
          description: "Dragonboat applied index is more than 1000 entries behind commit index."

      - alert: DragonboatSnapshotFailures
        expr: rate(nebulaio_dragonboat_snapshot_failures_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Dragonboat snapshot failures"
          description: "Dragonboat is experiencing snapshot creation failures."

      - alert: DragonboatHighLatency
        expr: nebulaio_dragonboat_propose_latency_seconds > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Dragonboat proposal latency"
          description: "Dragonboat proposal latency is above 1 second."

  # S3 API Alerts
  - name: nebulaio.s3api
    interval: 30s
    rules:
      - alert: HighS3Latency
        expr: histogram_quantile(0.99, rate(nebulaio_s3_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High S3 API latency"
          description: "99th percentile S3 request latency is above 1 second."

      - alert: HighS3ErrorRate
        expr: rate(nebulaio_s3_requests_total{status=~"5.."}[5m]) / rate(nebulaio_s3_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High S3 API error rate"
          description: "More than 5% of S3 requests are failing with 5xx errors."

      - alert: S3RequestQueueFull
        expr: nebulaio_s3_request_queue_length > 1000
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "S3 request queue is full"
          description: "S3 request queue has more than 1000 pending requests."

  # Storage Alerts
  - name: nebulaio.storage
    interval: 1m
    rules:
      - alert: LowDiskSpace
        expr: (nebulaio_storage_free_bytes / nebulaio_storage_total_bytes) < 0.15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Less than 15% disk space remaining on storage volume."

      - alert: CriticalDiskSpace
        expr: (nebulaio_storage_free_bytes / nebulaio_storage_total_bytes) < 0.05
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Critical disk space on {{ $labels.instance }}"
          description: "Less than 5% disk space remaining. Immediate action required."

      - alert: ErasureCodingErrors
        expr: rate(nebulaio_erasure_decode_failures_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Erasure coding decode failures detected"
          description: "Erasure coding is experiencing decode failures, indicating potential data corruption or missing shards."

      - alert: HighCacheMissRate
        expr: nebulaio_cache_miss_total / (nebulaio_cache_hit_total + nebulaio_cache_miss_total) > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High cache miss rate"
          description: "Cache miss rate is above 80%, which may impact performance."

  # Replication Alerts
  - name: nebulaio.replication
    interval: 1m
    rules:
      - alert: ReplicationQueueBacklog
        expr: nebulaio_replication_queue_length > 10000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Replication queue backlog"
          description: "Replication queue has more than 10,000 pending objects."

      - alert: ReplicationLag
        expr: nebulaio_replication_lag_seconds > 3600
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Replication lag detected"
          description: "Replication lag is more than 1 hour."

      - alert: ReplicationFailures
        expr: rate(nebulaio_replication_failures_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Replication failures detected"
          description: "Replication is experiencing failures at a rate > 0.1/sec."

  # AI/ML Feature Alerts
  - name: nebulaio.aiml
    interval: 30s
    rules:
      # S3 Express
      - alert: S3ExpressSessionLimit
        expr: nebulaio_s3express_sessions_active > 1000
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: s3_express
        annotations:
          summary: "High number of S3 Express sessions"
          description: "More than 1000 active S3 Express sessions."

      # Iceberg
      - alert: IcebergTransactionFailures
        expr: rate(nebulaio_iceberg_transaction_failures_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: iceberg
        annotations:
          summary: "Iceberg transaction failures"
          description: "Iceberg transactions are failing at a rate > 0.1/sec."

      # MCP Server
      - alert: MCPHighLatency
        expr: nebulaio_mcp_request_latency_seconds > 5
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: mcp
        annotations:
          summary: "High MCP request latency"
          description: "MCP requests are taking more than 5 seconds on average."

      - alert: MCPConnectionLimit
        expr: nebulaio_mcp_connections_active > 100
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: mcp
        annotations:
          summary: "High number of MCP connections"
          description: "More than 100 active MCP connections."

      # GPUDirect
      - alert: GPUDirectTransferErrors
        expr: rate(nebulaio_gpudirect_transfer_errors_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: gpudirect
        annotations:
          summary: "GPUDirect transfer errors"
          description: "GPUDirect is experiencing transfer errors."

      - alert: GPUMemoryExhaustion
        expr: nebulaio_gpudirect_buffer_pool_free_bytes / nebulaio_gpudirect_buffer_pool_size_bytes < 0.1
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: gpudirect
        annotations:
          summary: "GPUDirect buffer pool nearly exhausted"
          description: "Less than 10% of GPUDirect buffer pool is free."

      # DPU
      - alert: DPUOffloadFailures
        expr: rate(nebulaio_dpu_offload_failures_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: dpu
        annotations:
          summary: "DPU offload failures"
          description: "DPU offload operations are failing at a rate > 0.1/sec."

      - alert: DPUFallbackActive
        expr: nebulaio_dpu_fallback_active == 1
        for: 1m
        labels:
          severity: warning
          feature: aiml
          feature_name: dpu
        annotations:
          summary: "DPU fallback mode active"
          description: "DPU is in fallback mode, operations are running on CPU."

      # RDMA
      - alert: RDMAConnectionErrors
        expr: rate(nebulaio_rdma_connection_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: rdma
        annotations:
          summary: "RDMA connection errors"
          description: "RDMA is experiencing connection errors at a rate > 0.1/sec."

      - alert: RDMAHighLatency
        expr: nebulaio_rdma_operation_latency_microseconds > 100
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: rdma
        annotations:
          summary: "High RDMA latency"
          description: "RDMA operations are taking more than 100 microseconds on average."

      # NIM
      - alert: NIMInferenceErrors
        expr: rate(nebulaio_nim_inference_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: nim
        annotations:
          summary: "NIM inference errors"
          description: "NIM inference is failing at a rate > 0.1/sec."

      - alert: NIMQuotaExhausted
        expr: nebulaio_nim_quota_remaining < 100
        for: 5m
        labels:
          severity: warning
          feature: aiml
          feature_name: nim
        annotations:
          summary: "NIM API quota nearly exhausted"
          description: "Less than 100 NIM API calls remaining in quota."

  # Security Alerts
  - name: nebulaio.security
    interval: 1m
    rules:
      - alert: HighAuthFailureRate
        expr: rate(nebulaio_auth_failures_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High authentication failure rate"
          description: "More than 10 authentication failures per second, possible brute force attack."

      - alert: UnauthorizedAccessAttempts
        expr: rate(nebulaio_unauthorized_access_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Unauthorized access attempts detected"
          description: "More than 5 unauthorized access attempts per second."

      - alert: RateLimitExceeded
        expr: rate(nebulaio_rate_limit_exceeded_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Rate limit exceeded frequently"
          description: "Rate limits are being exceeded frequently, may indicate abuse."
