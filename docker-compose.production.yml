# NebulaIO Production Docker Compose Configuration
# Usage: docker-compose -f docker-compose.yml -f docker-compose.production.yml up -d
#
# This overlay enables all advanced features with production-ready defaults.
# TLS is enabled by default with auto-generated certificates.

version: '3.8'

services:
  nebulaio:
    environment:
      # TLS Configuration (enabled by default)
      # Auto-generated certificates are stored in /data/certs
      # For production with custom certificates, mount them and set:
      # - NEBULAIO_TLS_CERT_FILE=/etc/nebulaio/certs/server.crt
      # - NEBULAIO_TLS_KEY_FILE=/etc/nebulaio/certs/server.key
      # - NEBULAIO_TLS_CA_FILE=/etc/nebulaio/certs/ca.crt
      - NEBULAIO_TLS_MIN_VERSION=1.2
      - NEBULAIO_TLS_ORGANIZATION=NebulaIO
      - NEBULAIO_TLS_VALIDITY_DAYS=365

      # DRAM Cache
      - NEBULAIO_CACHE_ENABLED=true
      - NEBULAIO_CACHE_MAX_SIZE=8589934592
      - NEBULAIO_CACHE_SHARD_COUNT=256
      - NEBULAIO_CACHE_ENTRY_MAX_SIZE=268435456
      - NEBULAIO_CACHE_TTL=3600
      - NEBULAIO_CACHE_EVICTION_POLICY=arc
      - NEBULAIO_CACHE_PREFETCH_ENABLED=true
      - NEBULAIO_CACHE_PREFETCH_THRESHOLD=2
      - NEBULAIO_CACHE_PREFETCH_AHEAD=4
      - NEBULAIO_CACHE_ZERO_COPY_ENABLED=true

      # Data Firewall - Rate Limiting
      - NEBULAIO_FIREWALL_ENABLED=true
      - NEBULAIO_FIREWALL_DEFAULT_POLICY=allow
      - NEBULAIO_FIREWALL_AUDIT_ENABLED=true
      - NEBULAIO_FIREWALL_RATE_LIMITING_ENABLED=true
      - NEBULAIO_FIREWALL_RATE_LIMIT_RPS=1000
      - NEBULAIO_FIREWALL_RATE_LIMIT_BURST=100
      - NEBULAIO_FIREWALL_RATE_LIMIT_PER_USER=true
      - NEBULAIO_FIREWALL_RATE_LIMIT_PER_IP=true

      # Data Firewall - Bandwidth
      - NEBULAIO_FIREWALL_BANDWIDTH_ENABLED=true
      - NEBULAIO_FIREWALL_BANDWIDTH_MAX_BPS=1073741824
      - NEBULAIO_FIREWALL_BANDWIDTH_MAX_BPS_PER_USER=104857600
      - NEBULAIO_FIREWALL_BANDWIDTH_MAX_BPS_PER_BUCKET=524288000

      # Data Firewall - Connections
      - NEBULAIO_FIREWALL_CONNECTIONS_ENABLED=true
      - NEBULAIO_FIREWALL_MAX_CONNECTIONS=10000
      - NEBULAIO_FIREWALL_MAX_CONNECTIONS_PER_IP=100
      - NEBULAIO_FIREWALL_MAX_CONNECTIONS_PER_USER=500

      # S3 Select
      - NEBULAIO_S3SELECT_ENABLED=true
      - NEBULAIO_S3SELECT_MAX_RECORD_SIZE=1048576
      - NEBULAIO_S3SELECT_MAX_RESULTS_SIZE=268435456
      - NEBULAIO_S3SELECT_TIMEOUT=300
      - NEBULAIO_S3SELECT_WORKER_POOL_SIZE=10

      # Batch Replication
      - NEBULAIO_BATCH_REPLICATION_ENABLED=true
      - NEBULAIO_BATCH_REPLICATION_MAX_JOBS=5
      - NEBULAIO_BATCH_REPLICATION_CONCURRENCY=10
      - NEBULAIO_BATCH_REPLICATION_MAX_RETRIES=3
      - NEBULAIO_BATCH_REPLICATION_RETRY_DELAY=5s
      - NEBULAIO_BATCH_REPLICATION_HISTORY_LIMIT=100
      - NEBULAIO_BATCH_REPLICATION_CHECKPOINT_INTERVAL=1000

      # Enhanced Audit Logging
      - NEBULAIO_AUDIT_ENABLED=true
      - NEBULAIO_AUDIT_COMPLIANCE_MODE=soc2
      - NEBULAIO_AUDIT_FILE_PATH=/data/audit/audit.log
      - NEBULAIO_AUDIT_RETENTION_DAYS=90
      - NEBULAIO_AUDIT_BUFFER_SIZE=10000
      - NEBULAIO_AUDIT_INTEGRITY_ENABLED=true
      - NEBULAIO_AUDIT_MASK_SENSITIVE=true
      - NEBULAIO_AUDIT_ROTATION_ENABLED=true
      - NEBULAIO_AUDIT_ROTATION_MAX_SIZE_MB=100
      - NEBULAIO_AUDIT_ROTATION_MAX_AGE_DAYS=7
      - NEBULAIO_AUDIT_ROTATION_MAX_BACKUPS=10
      - NEBULAIO_AUDIT_ROTATION_COMPRESS=true

      # Placement Groups (for distributed deployments)
      # Configure when running multiple nodes across datacenters
      # - NEBULAIO_PLACEMENT_GROUP_LOCAL_ID=pg-dc1
      # - NEBULAIO_PLACEMENT_GROUP_MIN_NODES_FOR_ERASURE=3
      # - NEBULAIO_PLACEMENT_GROUP_DATACENTER=dc1
      # - NEBULAIO_PLACEMENT_GROUP_REGION=us-east-1

      # Default Redundancy Configuration (production recommended: 10+4)
      - NEBULAIO_REDUNDANCY_ENABLED=true
      - NEBULAIO_REDUNDANCY_DATA_SHARDS=10
      - NEBULAIO_REDUNDANCY_PARITY_SHARDS=4
      - NEBULAIO_REDUNDANCY_PLACEMENT_POLICY=spread
      - NEBULAIO_REDUNDANCY_REPLICATION_FACTOR=0

      # Storage Tiering (enable for multi-tier storage)
      # - NEBULAIO_TIERING_ENABLED=true
      # - NEBULAIO_TIERING_HOT_BACKEND=erasure
      # - NEBULAIO_TIERING_HOT_DIR=/data/tiering/hot
      # - NEBULAIO_TIERING_WARM_BACKEND=volume
      # - NEBULAIO_TIERING_WARM_DIR=/data/tiering/warm
      # - NEBULAIO_TIERING_COLD_BACKEND=fs
      # - NEBULAIO_TIERING_COLD_DIR=/data/tiering/cold

    # Increase memory for DRAM cache
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 8G

    volumes:
      - nebulaio-data:/data
      - nebulaio-audit:/data/audit

volumes:
  nebulaio-audit:
    driver: local
