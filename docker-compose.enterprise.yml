# NebulaIO Enterprise Docker Compose Configuration
# Usage: docker-compose -f docker-compose.yml -f docker-compose.enterprise.yml up -d
#
# This overlay enables all enterprise features with production-ready defaults.

version: '3.8'

services:
  nebulaio:
    environment:
      # Enterprise DRAM Cache
      - NEBULAIO_CACHE_ENABLED=true
      - NEBULAIO_CACHE_MAX_SIZE=8589934592
      - NEBULAIO_CACHE_SHARD_COUNT=256
      - NEBULAIO_CACHE_ENTRY_MAX_SIZE=268435456
      - NEBULAIO_CACHE_TTL=3600
      - NEBULAIO_CACHE_EVICTION_POLICY=arc
      - NEBULAIO_CACHE_PREFETCH_ENABLED=true
      - NEBULAIO_CACHE_PREFETCH_THRESHOLD=2
      - NEBULAIO_CACHE_PREFETCH_AHEAD=4
      - NEBULAIO_CACHE_ZERO_COPY_ENABLED=true

      # Data Firewall - Rate Limiting
      - NEBULAIO_FIREWALL_ENABLED=true
      - NEBULAIO_FIREWALL_DEFAULT_POLICY=allow
      - NEBULAIO_FIREWALL_AUDIT_ENABLED=true
      - NEBULAIO_FIREWALL_RATE_LIMITING_ENABLED=true
      - NEBULAIO_FIREWALL_RATE_LIMIT_RPS=1000
      - NEBULAIO_FIREWALL_RATE_LIMIT_BURST=100
      - NEBULAIO_FIREWALL_RATE_LIMIT_PER_USER=true
      - NEBULAIO_FIREWALL_RATE_LIMIT_PER_IP=true

      # Data Firewall - Bandwidth
      - NEBULAIO_FIREWALL_BANDWIDTH_ENABLED=true
      - NEBULAIO_FIREWALL_BANDWIDTH_MAX_BPS=1073741824
      - NEBULAIO_FIREWALL_BANDWIDTH_MAX_BPS_PER_USER=104857600
      - NEBULAIO_FIREWALL_BANDWIDTH_MAX_BPS_PER_BUCKET=524288000

      # Data Firewall - Connections
      - NEBULAIO_FIREWALL_CONNECTIONS_ENABLED=true
      - NEBULAIO_FIREWALL_MAX_CONNECTIONS=10000
      - NEBULAIO_FIREWALL_MAX_CONNECTIONS_PER_IP=100
      - NEBULAIO_FIREWALL_MAX_CONNECTIONS_PER_USER=500

      # S3 Select
      - NEBULAIO_S3SELECT_ENABLED=true
      - NEBULAIO_S3SELECT_MAX_RECORD_SIZE=1048576
      - NEBULAIO_S3SELECT_MAX_RESULTS_SIZE=268435456
      - NEBULAIO_S3SELECT_TIMEOUT=300
      - NEBULAIO_S3SELECT_WORKER_POOL_SIZE=10

      # Batch Replication
      - NEBULAIO_BATCH_REPLICATION_ENABLED=true
      - NEBULAIO_BATCH_REPLICATION_MAX_JOBS=5
      - NEBULAIO_BATCH_REPLICATION_CONCURRENCY=10
      - NEBULAIO_BATCH_REPLICATION_MAX_RETRIES=3
      - NEBULAIO_BATCH_REPLICATION_RETRY_DELAY=5s
      - NEBULAIO_BATCH_REPLICATION_HISTORY_LIMIT=100
      - NEBULAIO_BATCH_REPLICATION_CHECKPOINT_INTERVAL=1000

      # Enhanced Audit Logging
      - NEBULAIO_AUDIT_ENABLED=true
      - NEBULAIO_AUDIT_COMPLIANCE_MODE=soc2
      - NEBULAIO_AUDIT_FILE_PATH=/data/audit/audit.log
      - NEBULAIO_AUDIT_RETENTION_DAYS=90
      - NEBULAIO_AUDIT_BUFFER_SIZE=10000
      - NEBULAIO_AUDIT_INTEGRITY_ENABLED=true
      - NEBULAIO_AUDIT_MASK_SENSITIVE=true
      - NEBULAIO_AUDIT_ROTATION_ENABLED=true
      - NEBULAIO_AUDIT_ROTATION_MAX_SIZE_MB=100
      - NEBULAIO_AUDIT_ROTATION_MAX_AGE_DAYS=7
      - NEBULAIO_AUDIT_ROTATION_MAX_BACKUPS=10
      - NEBULAIO_AUDIT_ROTATION_COMPRESS=true

    # Increase memory for DRAM cache
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 8G

    volumes:
      - nebulaio-data:/data
      - nebulaio-audit:/data/audit

volumes:
  nebulaio-audit:
    driver: local
