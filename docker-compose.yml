version: '3.8'

services:
  nebulaio:
    build:
      context: .
      dockerfile: deployments/docker/Dockerfile
    container_name: nebulaio
    ports:
      - "9000:9000"  # S3 API
      - "9001:9001"  # Admin/Console API (includes /metrics endpoint)
      - "9002:9002"  # Web Console
      - "9005:9005"  # MCP Server (when enabled)
      - "9100:9100"  # RDMA (when enabled)
    volumes:
      - nebulaio-data:/data
    environment:
      - NEBULAIO_DATA_DIR=/data
      - NEBULAIO_LOG_LEVEL=info
      - NEBULAIO_AUTH_ROOT_USER=admin
      # REQUIRED: Set a secure password (min 12 chars, with uppercase, lowercase, and number)
      # Example: export NEBULAIO_AUTH_ROOT_PASSWORD="YourSecurePass123"
      - NEBULAIO_AUTH_ROOT_PASSWORD=${NEBULAIO_AUTH_ROOT_PASSWORD:?Error: NEBULAIO_AUTH_ROOT_PASSWORD must be set (min 12 chars)}

      # TLS is enabled by default with auto-generated certificates
      # The certificates are stored in /data/certs
      # To use custom certificates:
      # - NEBULAIO_TLS_CERT_FILE=/data/certs/custom-server.crt
      # - NEBULAIO_TLS_KEY_FILE=/data/certs/custom-server.key
      # To disable TLS (NOT recommended):
      # - NEBULAIO_TLS_ENABLED=false

      # DRAM Cache (uncomment to enable)
      # - NEBULAIO_CACHE_ENABLED=true
      # - NEBULAIO_CACHE_MAX_SIZE=8589934592
      # - NEBULAIO_CACHE_EVICTION_POLICY=arc
      # - NEBULAIO_CACHE_PREFETCH_ENABLED=true

      # Data Firewall (uncomment to enable)
      # - NEBULAIO_FIREWALL_ENABLED=true
      # - NEBULAIO_FIREWALL_RATE_LIMIT_RPS=1000
      # - NEBULAIO_FIREWALL_BANDWIDTH_MAX_BPS=1073741824

      # Rate Limiting - Object Creation (Hash DoS Protection)
      # Protects against attacks that target object key distribution
      # - NEBULAIO_FIREWALL_OBJECT_CREATION_LIMIT=1000   # RPS for PutObject, CopyObject, etc.
      # - NEBULAIO_FIREWALL_OBJECT_CREATION_BURST=2000   # Burst size for object creation

      # S3 Select (enabled by default)
      - NEBULAIO_S3SELECT_ENABLED=true

      # Audit Logging (enabled by default)
      - NEBULAIO_AUDIT_ENABLED=true
      - NEBULAIO_AUDIT_FILE_PATH=/data/audit/audit.log

      # =========================================================================
      # AI/ML & High-Performance Features (2025)
      # =========================================================================

      # S3 Express One Zone (uncomment to enable)
      # - NEBULAIO_S3_EXPRESS_ENABLED=true
      # - NEBULAIO_S3_EXPRESS_DEFAULT_ZONE=use1-az1
      # - NEBULAIO_S3_EXPRESS_ENABLE_ATOMIC_APPEND=true

      # Apache Iceberg (uncomment to enable)
      # - NEBULAIO_ICEBERG_ENABLED=true
      # - NEBULAIO_ICEBERG_CATALOG_TYPE=rest
      # - NEBULAIO_ICEBERG_CATALOG_URI=http://localhost:8181
      # - NEBULAIO_ICEBERG_WAREHOUSE=s3://warehouse/
      # - NEBULAIO_ICEBERG_ENABLE_ACID=true

      # MCP Server for AI Agents (uncomment to enable)
      # - NEBULAIO_MCP_ENABLED=true
      # - NEBULAIO_MCP_PORT=9005
      # - NEBULAIO_MCP_ENABLE_TOOLS=true
      # - NEBULAIO_MCP_ENABLE_RESOURCES=true
      # - NEBULAIO_MCP_AUTH_REQUIRED=true

      # GPUDirect Storage (uncomment to enable - requires NVIDIA GPU)
      # - NEBULAIO_GPUDIRECT_ENABLED=true
      # - NEBULAIO_GPUDIRECT_BUFFER_POOL_SIZE=1073741824
      # - NEBULAIO_GPUDIRECT_ENABLE_ASYNC=true
      # - NEBULAIO_GPUDIRECT_ENABLE_P2P=true

      # BlueField DPU (uncomment to enable - requires BlueField hardware)
      # - NEBULAIO_DPU_ENABLED=true
      # - NEBULAIO_DPU_DEVICE_INDEX=0
      # - NEBULAIO_DPU_ENABLE_CRYPTO=true
      # - NEBULAIO_DPU_ENABLE_COMPRESSION=true
      # - NEBULAIO_DPU_ENABLE_RDMA=true
      # - NEBULAIO_DPU_FALLBACK_ON_ERROR=true

      # S3 over RDMA (uncomment to enable - requires RDMA NIC)
      # - NEBULAIO_RDMA_ENABLED=true
      # - NEBULAIO_RDMA_PORT=9100
      # - NEBULAIO_RDMA_DEVICE_NAME=mlx5_0
      # - NEBULAIO_RDMA_ENABLE_ZERO_COPY=true
      # - NEBULAIO_RDMA_FALLBACK_TO_TCP=true

      # NVIDIA NIM Microservices (uncomment to enable)
      # - NEBULAIO_NIM_ENABLED=true
      # - NEBULAIO_NIM_API_KEY=your-nvidia-api-key
      # - NEBULAIO_NIM_DEFAULT_MODEL=meta/llama-3.1-8b-instruct
      # - NEBULAIO_NIM_ENABLE_STREAMING=true
      # - NEBULAIO_NIM_CACHE_RESULTS=true
      # - NEBULAIO_NIM_PROCESS_ON_UPLOAD=false

      # =========================================================================
      # Placement Groups & Redundancy (for distributed deployments)
      # =========================================================================

      # Placement Groups (uncomment to enable)
      # - NEBULAIO_PLACEMENT_GROUP_LOCAL_ID=pg-default
      # - NEBULAIO_PLACEMENT_GROUP_MIN_NODES_FOR_ERASURE=3
      # - NEBULAIO_PLACEMENT_GROUP_DATACENTER=dc1
      # - NEBULAIO_PLACEMENT_GROUP_REGION=us-east-1

      # Default Redundancy Configuration (for erasure coding)
      # - NEBULAIO_REDUNDANCY_ENABLED=true
      # - NEBULAIO_REDUNDANCY_DATA_SHARDS=10
      # - NEBULAIO_REDUNDANCY_PARITY_SHARDS=4
      # - NEBULAIO_REDUNDANCY_PLACEMENT_POLICY=spread
      # - NEBULAIO_REDUNDANCY_REPLICATION_FACTOR=0

      # Storage Tiering (uncomment to enable)
      # - NEBULAIO_TIERING_ENABLED=true
      # - NEBULAIO_TIERING_HOT_BACKEND=erasure
      # - NEBULAIO_TIERING_HOT_DIR=/data/tiering/hot
      # - NEBULAIO_TIERING_WARM_BACKEND=volume
      # - NEBULAIO_TIERING_WARM_DIR=/data/tiering/warm
      # - NEBULAIO_TIERING_COLD_BACKEND=fs
      # - NEBULAIO_TIERING_COLD_DIR=/data/tiering/cold

    restart: unless-stopped
    healthcheck:
      # Use HTTPS since TLS is enabled by default
      test: ["CMD", "wget", "--no-check-certificate", "--no-verbose", "--tries=1", "--spider", "https://localhost:9001/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  nebulaio-data:
    driver: local

# 3-Node Cluster Configuration
# To use: docker-compose -f docker-compose.yml -f docker-compose.cluster.yml up -d
#
# Or copy the cluster section below into a separate docker-compose.cluster.yml file
