version: '3.8'

# 3-Node NebulaIO Cluster Configuration
# Usage: docker-compose -f docker-compose.cluster.yml up -d
#
# This configuration creates a 3-node cluster with:
# - Dragonboat Raft consensus for metadata (high-performance multi-group Raft)
# - Gossip-based node discovery (memberlist)
# - High availability with leader election
#
# Dragonboat Configuration:
# - shard_id: 1 (all nodes in same Raft group)
# - replica_id: unique per node (1, 2, 3)
#
# Access Points:
# - Node 1: S3 API at http://localhost:9000, Admin API at http://localhost:9001
# - Node 2: S3 API at http://localhost:9100, Admin API at http://localhost:9101
# - Node 3: S3 API at http://localhost:9200, Admin API at http://localhost:9201
#
# Cluster Management:
# - List nodes: curl http://localhost:9001/api/v1/admin/cluster/nodes
# - Get leader: curl http://localhost:9001/api/v1/admin/cluster/leader
# - Cluster health: curl http://localhost:9001/api/v1/admin/cluster/health

services:
  nebulaio-1:
    build:
      context: .
      dockerfile: deployments/docker/Dockerfile
    container_name: nebulaio-1
    hostname: nebulaio-1
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Admin/Console API
      - "9002:9002"   # Web Console
    volumes:
      - nebulaio-data-1:/data
    environment:
      # Node identification
      - NEBULAIO_NODE_ID=node-1
      - NEBULAIO_NODE_NAME=nebulaio-1
      - NEBULAIO_DATA_DIR=/data
      - NEBULAIO_LOG_LEVEL=info
      
      # Authentication
      - NEBULAIO_AUTH_ROOT_USER=admin
      - NEBULAIO_AUTH_ROOT_PASSWORD=admin123
      
      # Cluster configuration - Node 1 bootstraps the cluster
      - NEBULAIO_CLUSTER_BOOTSTRAP=true
      - NEBULAIO_CLUSTER_ADVERTISE_ADDRESS=nebulaio-1
      - NEBULAIO_CLUSTER_SHARD_ID=1
      - NEBULAIO_CLUSTER_REPLICA_ID=1
      - NEBULAIO_CLUSTER_RAFT_PORT=9003
      - NEBULAIO_CLUSTER_GOSSIP_PORT=9004
      - NEBULAIO_CLUSTER_NODE_ROLE=storage
      - NEBULAIO_CLUSTER_CLUSTER_NAME=nebulaio-cluster
      - NEBULAIO_CLUSTER_EXPECT_NODES=3
      
      # Network ports
      - NEBULAIO_S3_PORT=9000
      - NEBULAIO_ADMIN_PORT=9001
      - NEBULAIO_CONSOLE_PORT=9002

      # Placement Groups - All nodes in same datacenter/placement group
      - NEBULAIO_PLACEMENT_GROUP_LOCAL_ID=pg-dc1
      - NEBULAIO_PLACEMENT_GROUP_MIN_NODES_FOR_ERASURE=3
      - NEBULAIO_PLACEMENT_GROUP_DATACENTER=dc1
      - NEBULAIO_PLACEMENT_GROUP_REGION=local

      # Redundancy Configuration (4+2 for 3-node cluster)
      - NEBULAIO_REDUNDANCY_ENABLED=true
      - NEBULAIO_REDUNDANCY_DATA_SHARDS=4
      - NEBULAIO_REDUNDANCY_PARITY_SHARDS=2
      - NEBULAIO_REDUNDANCY_PLACEMENT_POLICY=spread
    networks:
      nebulaio-cluster:
        aliases:
          - nebulaio-1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9001/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  nebulaio-2:
    build:
      context: .
      dockerfile: deployments/docker/Dockerfile
    container_name: nebulaio-2
    hostname: nebulaio-2
    ports:
      - "9100:9000"   # S3 API
      - "9101:9001"   # Admin/Console API
      - "9102:9002"   # Web Console
    volumes:
      - nebulaio-data-2:/data
    environment:
      # Node identification
      - NEBULAIO_NODE_ID=node-2
      - NEBULAIO_NODE_NAME=nebulaio-2
      - NEBULAIO_DATA_DIR=/data
      - NEBULAIO_LOG_LEVEL=info
      
      # Authentication
      - NEBULAIO_AUTH_ROOT_USER=admin
      - NEBULAIO_AUTH_ROOT_PASSWORD=admin123
      
      # Cluster configuration - Node 2 joins node 1
      - NEBULAIO_CLUSTER_BOOTSTRAP=false
      - NEBULAIO_CLUSTER_JOIN_ADDRESSES=nebulaio-1:9004
      - NEBULAIO_CLUSTER_ADVERTISE_ADDRESS=nebulaio-2
      - NEBULAIO_CLUSTER_SHARD_ID=1
      - NEBULAIO_CLUSTER_REPLICA_ID=2
      - NEBULAIO_CLUSTER_RAFT_PORT=9003
      - NEBULAIO_CLUSTER_GOSSIP_PORT=9004
      - NEBULAIO_CLUSTER_NODE_ROLE=storage
      - NEBULAIO_CLUSTER_CLUSTER_NAME=nebulaio-cluster
      
      # Network ports
      - NEBULAIO_S3_PORT=9000
      - NEBULAIO_ADMIN_PORT=9001
      - NEBULAIO_CONSOLE_PORT=9002

      # Placement Groups - All nodes in same datacenter/placement group
      - NEBULAIO_PLACEMENT_GROUP_LOCAL_ID=pg-dc1
      - NEBULAIO_PLACEMENT_GROUP_MIN_NODES_FOR_ERASURE=3
      - NEBULAIO_PLACEMENT_GROUP_DATACENTER=dc1
      - NEBULAIO_PLACEMENT_GROUP_REGION=local

      # Redundancy Configuration (4+2 for 3-node cluster)
      - NEBULAIO_REDUNDANCY_ENABLED=true
      - NEBULAIO_REDUNDANCY_DATA_SHARDS=4
      - NEBULAIO_REDUNDANCY_PARITY_SHARDS=2
      - NEBULAIO_REDUNDANCY_PLACEMENT_POLICY=spread
    networks:
      nebulaio-cluster:
        aliases:
          - nebulaio-2
    depends_on:
      nebulaio-1:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9001/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  nebulaio-3:
    build:
      context: .
      dockerfile: deployments/docker/Dockerfile
    container_name: nebulaio-3
    hostname: nebulaio-3
    ports:
      - "9200:9000"   # S3 API
      - "9201:9001"   # Admin/Console API
      - "9202:9002"   # Web Console
    volumes:
      - nebulaio-data-3:/data
    environment:
      # Node identification
      - NEBULAIO_NODE_ID=node-3
      - NEBULAIO_NODE_NAME=nebulaio-3
      - NEBULAIO_DATA_DIR=/data
      - NEBULAIO_LOG_LEVEL=info
      
      # Authentication
      - NEBULAIO_AUTH_ROOT_USER=admin
      - NEBULAIO_AUTH_ROOT_PASSWORD=admin123
      
      # Cluster configuration - Node 3 joins node 1
      - NEBULAIO_CLUSTER_BOOTSTRAP=false
      - NEBULAIO_CLUSTER_JOIN_ADDRESSES=nebulaio-1:9004
      - NEBULAIO_CLUSTER_ADVERTISE_ADDRESS=nebulaio-3
      - NEBULAIO_CLUSTER_SHARD_ID=1
      - NEBULAIO_CLUSTER_REPLICA_ID=3
      - NEBULAIO_CLUSTER_RAFT_PORT=9003
      - NEBULAIO_CLUSTER_GOSSIP_PORT=9004
      - NEBULAIO_CLUSTER_NODE_ROLE=storage
      - NEBULAIO_CLUSTER_CLUSTER_NAME=nebulaio-cluster
      
      # Network ports
      - NEBULAIO_S3_PORT=9000
      - NEBULAIO_ADMIN_PORT=9001
      - NEBULAIO_CONSOLE_PORT=9002

      # Placement Groups - All nodes in same datacenter/placement group
      - NEBULAIO_PLACEMENT_GROUP_LOCAL_ID=pg-dc1
      - NEBULAIO_PLACEMENT_GROUP_MIN_NODES_FOR_ERASURE=3
      - NEBULAIO_PLACEMENT_GROUP_DATACENTER=dc1
      - NEBULAIO_PLACEMENT_GROUP_REGION=local

      # Redundancy Configuration (4+2 for 3-node cluster)
      - NEBULAIO_REDUNDANCY_ENABLED=true
      - NEBULAIO_REDUNDANCY_DATA_SHARDS=4
      - NEBULAIO_REDUNDANCY_PARITY_SHARDS=2
      - NEBULAIO_REDUNDANCY_PLACEMENT_POLICY=spread
    networks:
      nebulaio-cluster:
        aliases:
          - nebulaio-3
    depends_on:
      nebulaio-1:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9001/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  nebulaio-data-1:
    driver: local
  nebulaio-data-2:
    driver: local
  nebulaio-data-3:
    driver: local

networks:
  nebulaio-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
